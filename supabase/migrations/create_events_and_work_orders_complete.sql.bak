-- ============================================================================
-- MIGRATION COMPLETA: Events e Work Orders (Reports)
-- ============================================================================
-- Este arquivo contém TODAS as migrations necessárias para os sistemas de
-- Events e Work Orders (Reports) em um único arquivo.
--
-- Execute este arquivo completo no SQL Editor do Supabase para criar todas
-- as tabelas, índices, RLS policies e triggers necessários.
--
-- Ordem de execução garantida: Tabelas dependentes são criadas após suas
-- tabelas pai usando CREATE TABLE IF NOT EXISTS.
-- ============================================================================

-- ============================================================================
-- PARTE 1: EVENTS (Sistema de Eventos)
-- ============================================================================

-- 1.1. Create events table (base schema)
CREATE TABLE IF NOT EXISTS events (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title VARCHAR(255) NOT NULL,
  description TEXT,
  created_by UUID NOT NULL REFERENCES users(id) ON DELETE RESTRICT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Create indexes for events
CREATE INDEX IF NOT EXISTS idx_events_created_by ON events(created_by);
CREATE INDEX IF NOT EXISTS idx_events_created_at ON events(created_at);

-- Enable RLS for events
ALTER TABLE events ENABLE ROW LEVEL SECURITY;

-- RLS Policy: Users can view events (drop if exists first)
DROP POLICY IF EXISTS "Users can view events" ON events;
CREATE POLICY "Users can view events"
  ON events
  FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.user_type = 'Master'
      AND users.is_active = true
    )
    OR
    EXISTS (
      SELECT 1 FROM user_permissions up
      JOIN permissions p ON p.id = up.permission_id
      WHERE up.user_id = auth.uid()
      AND p.key = 'events.view'
    )
    OR
    created_by = auth.uid()
  );

-- RLS Policy: Users can insert events (drop if exists first)
DROP POLICY IF EXISTS "Users can insert events" ON events;
CREATE POLICY "Users can insert events"
  ON events
  FOR INSERT
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.user_type = 'Master'
      AND users.is_active = true
    )
    OR
    EXISTS (
      SELECT 1 FROM user_permissions up
      JOIN permissions p ON p.id = up.permission_id
      WHERE up.user_id = auth.uid()
      AND p.key = 'events.create'
    )
    AND created_by = auth.uid()
  );

-- RLS Policy: Users can update events (drop if exists first)
DROP POLICY IF EXISTS "Users can update events" ON events;
CREATE POLICY "Users can update events"
  ON events
  FOR UPDATE
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.user_type = 'Master'
      AND users.is_active = true
    )
    OR
    EXISTS (
      SELECT 1 FROM user_permissions up
      JOIN permissions p ON p.id = up.permission_id
      WHERE up.user_id = auth.uid()
      AND p.key = 'events.update'
    )
    OR
    created_by = auth.uid()
  );

-- RLS Policy: Users can delete events (drop if exists first)
DROP POLICY IF EXISTS "Users can delete events" ON events;
CREATE POLICY "Users can delete events"
  ON events
  FOR DELETE
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.user_type = 'Master'
      AND users.is_active = true
    )
    OR
    EXISTS (
      SELECT 1 FROM user_permissions up
      JOIN permissions p ON p.id = up.permission_id
      WHERE up.user_id = auth.uid()
      AND p.key = 'events.delete'
    )
    OR
    created_by = auth.uid()
  );

-- 1.2. Add new columns to events table if they don't exist
ALTER TABLE events 
  ADD COLUMN IF NOT EXISTS type VARCHAR(50) DEFAULT 'other',
  ADD COLUMN IF NOT EXISTS start_date DATE,
  ADD COLUMN IF NOT EXISTS end_date DATE,
  ADD COLUMN IF NOT EXISTS start_time TIME,
  ADD COLUMN IF NOT EXISTS end_time TIME,
  ADD COLUMN IF NOT EXISTS location TEXT,
  ADD COLUMN IF NOT EXISTS people TEXT DEFAULT '';

-- If people column already exists as UUID[], drop and recreate as TEXT
DO $$ 
BEGIN
  IF EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'events' 
    AND column_name = 'people' 
    AND data_type = 'ARRAY'
  ) THEN
    ALTER TABLE events DROP COLUMN people;
    ALTER TABLE events ADD COLUMN people TEXT DEFAULT '';
  END IF;
END $$;

-- Create index for type filtering on events
CREATE INDEX IF NOT EXISTS idx_events_type ON events(type);
CREATE INDEX IF NOT EXISTS idx_events_start_date ON events(start_date);
CREATE INDEX IF NOT EXISTS idx_events_end_date ON events(end_date);

-- 1.3. Create event_attachments table
CREATE TABLE IF NOT EXISTS event_attachments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  event_id UUID NOT NULL REFERENCES events(id) ON DELETE CASCADE,
  filename VARCHAR(255) NOT NULL,
  mime_type VARCHAR(100) NOT NULL,
  storage_path TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_event_attachments_event_id ON event_attachments(event_id);
CREATE INDEX IF NOT EXISTS idx_event_attachments_created_at ON event_attachments(created_at);

ALTER TABLE event_attachments ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view event attachments"
  ON event_attachments
  FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.user_type = 'Master'
      AND users.is_active = true
    )
    OR
    EXISTS (
      SELECT 1 FROM user_permissions up
      JOIN permissions p ON p.id = up.permission_id
      WHERE up.user_id = auth.uid()
      AND p.key = 'events.view'
    )
    OR
    EXISTS (
      SELECT 1 FROM events
      WHERE events.id = event_attachments.event_id
      AND events.created_by = auth.uid()
    )
  );

CREATE POLICY "Users can insert event attachments"
  ON event_attachments
  FOR INSERT
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.user_type = 'Master'
      AND users.is_active = true
    )
    OR
    EXISTS (
      SELECT 1 FROM user_permissions up
      JOIN permissions p ON p.id = up.permission_id
      WHERE up.user_id = auth.uid()
      AND p.key = 'events.create'
      AND EXISTS (
        SELECT 1 FROM events
        WHERE events.id = event_attachments.event_id
        AND events.created_by = auth.uid()
      )
    )
  );

CREATE POLICY "Users can delete event attachments"
  ON event_attachments
  FOR DELETE
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.user_type = 'Master'
      AND users.is_active = true
    )
    OR
    EXISTS (
      SELECT 1 FROM events
      WHERE events.id = event_attachments.event_id
      AND events.created_by = auth.uid()
    )
  );

-- ============================================================================
-- PARTE 2: WORK ORDERS (Sistema de Reports / Controle de Serviços)
-- ============================================================================

-- 2.1. Create work_orders table (MAIN TABLE - must be created first)
CREATE TABLE IF NOT EXISTS work_orders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  client_name VARCHAR(255) NOT NULL,
  client_address TEXT NOT NULL,
  client_contact VARCHAR(255) NOT NULL,
  service_type VARCHAR(50) NOT NULL CHECK (service_type IN ('maintenance', 'installation', 'internal', 'external')),
  scheduled_date DATE NOT NULL,
  scheduled_time TIME NOT NULL,
  status VARCHAR(50) NOT NULL DEFAULT 'planned' CHECK (status IN ('planned', 'in_progress', 'paused', 'completed', 'cancelled')),
  planned_checklist JSONB DEFAULT '[]'::jsonb,
  planned_materials JSONB DEFAULT '[]'::jsonb,
  internal_notes TEXT,
  team_members UUID[] DEFAULT '{}',
  responsible UUID NOT NULL REFERENCES users(id) ON DELETE RESTRICT,
  is_locked BOOLEAN DEFAULT false,
  created_by UUID NOT NULL REFERENCES users(id) ON DELETE RESTRICT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ
);

CREATE INDEX IF NOT EXISTS idx_work_orders_status ON work_orders(status);
CREATE INDEX IF NOT EXISTS idx_work_orders_service_type ON work_orders(service_type);
CREATE INDEX IF NOT EXISTS idx_work_orders_scheduled_date ON work_orders(scheduled_date);
CREATE INDEX IF NOT EXISTS idx_work_orders_responsible ON work_orders(responsible);
CREATE INDEX IF NOT EXISTS idx_work_orders_created_by ON work_orders(created_by);
CREATE INDEX IF NOT EXISTS idx_work_orders_team_members ON work_orders USING GIN(team_members);

ALTER TABLE work_orders ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view work orders"
  ON work_orders
  FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.user_type = 'Master'
      AND users.is_active = true
    )
    OR
    EXISTS (
      SELECT 1 FROM user_permissions up
      JOIN permissions p ON p.id = up.permission_id
      WHERE up.user_id = auth.uid()
      AND p.key = 'workOrders.view'
    )
    OR
    created_by = auth.uid()
    OR
    responsible = auth.uid()
    OR
    auth.uid() = ANY(team_members)
  );

CREATE POLICY "Users can insert work orders"
  ON work_orders
  FOR INSERT
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.user_type = 'Master'
      AND users.is_active = true
    )
    OR
    EXISTS (
      SELECT 1 FROM user_permissions up
      JOIN permissions p ON p.id = up.permission_id
      WHERE up.user_id = auth.uid()
      AND p.key = 'workOrders.create'
    )
    AND created_by = auth.uid()
  );

CREATE POLICY "Users can update work orders"
  ON work_orders
  FOR UPDATE
  USING (
    is_locked = false
    AND (
      EXISTS (
        SELECT 1 FROM users
        WHERE users.id = auth.uid()
        AND users.user_type = 'Master'
        AND users.is_active = true
      )
      OR
      EXISTS (
        SELECT 1 FROM user_permissions up
        JOIN permissions p ON p.id = up.permission_id
        WHERE up.user_id = auth.uid()
        AND p.key = 'workOrders.update'
      )
      OR
      created_by = auth.uid()
      OR
      responsible = auth.uid()
      OR
      auth.uid() = ANY(team_members)
    )
  )
  WITH CHECK (
    is_locked = false
  );

CREATE POLICY "Users can delete work orders"
  ON work_orders
  FOR DELETE
  USING (
    is_locked = false
    AND (
      EXISTS (
        SELECT 1 FROM users
        WHERE users.id = auth.uid()
        AND users.user_type = 'Master'
        AND users.is_active = true
      )
      OR
      EXISTS (
        SELECT 1 FROM user_permissions up
        JOIN permissions p ON p.id = up.permission_id
        WHERE up.user_id = auth.uid()
        AND p.key = 'workOrders.delete'
      )
      OR
      created_by = auth.uid()
    )
  );

-- Create function to automatically update updated_at timestamp
CREATE OR REPLACE FUNCTION update_work_orders_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER work_orders_updated_at_trigger
  BEFORE UPDATE ON work_orders
  FOR EACH ROW
  EXECUTE FUNCTION update_work_orders_updated_at();

-- 2.2. Create work_order_checkins table
CREATE TABLE IF NOT EXISTS work_order_checkins (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  work_order_id UUID NOT NULL REFERENCES work_orders(id) ON DELETE CASCADE,
  timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  latitude DECIMAL(10, 8) NOT NULL,
  longitude DECIMAL(11, 8) NOT NULL,
  tolerance_radius INTEGER NOT NULL DEFAULT 100,
  photo_path TEXT,
  performed_by UUID NOT NULL REFERENCES users(id) ON DELETE RESTRICT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_work_order_checkins_work_order_id ON work_order_checkins(work_order_id);
CREATE INDEX IF NOT EXISTS idx_work_order_checkins_performed_by ON work_order_checkins(performed_by);
CREATE INDEX IF NOT EXISTS idx_work_order_checkins_timestamp ON work_order_checkins(timestamp);

ALTER TABLE work_order_checkins ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view work order check-ins"
  ON work_order_checkins
  FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.user_type = 'Master'
      AND users.is_active = true
    )
    OR
    EXISTS (
      SELECT 1 FROM work_orders wo
      WHERE wo.id = work_order_checkins.work_order_id
      AND (
        wo.created_by = auth.uid()
        OR wo.responsible = auth.uid()
        OR auth.uid() = ANY(wo.team_members)
        OR EXISTS (
          SELECT 1 FROM user_permissions up
          JOIN permissions p ON p.id = up.permission_id
          WHERE up.user_id = auth.uid()
          AND p.key = 'workOrders.view'
        )
      )
    )
  );

CREATE POLICY "Users can insert work order check-ins"
  ON work_order_checkins
  FOR INSERT
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.user_type = 'Master'
      AND users.is_active = true
    )
    OR
    (
      EXISTS (
        SELECT 1 FROM user_permissions up
        JOIN permissions p ON p.id = up.permission_id
        WHERE up.user_id = auth.uid()
        AND p.key = 'workOrders.checkin'
      )
      AND performed_by = auth.uid()
      AND EXISTS (
        SELECT 1 FROM work_orders wo
        WHERE wo.id = work_order_checkins.work_order_id
        AND (wo.responsible = auth.uid() OR auth.uid() = ANY(wo.team_members))
      )
    )
  );

-- 2.3. Create work_order_time_statuses table
CREATE TABLE IF NOT EXISTS work_order_time_statuses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  work_order_id UUID NOT NULL REFERENCES work_orders(id) ON DELETE CASCADE,
  status VARCHAR(50) NOT NULL CHECK (status IN ('EM_ATENDIMENTO', 'PAUSADO', 'DESLOCAMENTO')),
  pause_reason TEXT,
  start_time TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  end_time TIMESTAMPTZ,
  total_duration INTEGER DEFAULT 0,
  created_by UUID NOT NULL REFERENCES users(id) ON DELETE RESTRICT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_work_order_time_statuses_work_order_id ON work_order_time_statuses(work_order_id);
CREATE INDEX IF NOT EXISTS idx_work_order_time_statuses_status ON work_order_time_statuses(status);
CREATE INDEX IF NOT EXISTS idx_work_order_time_statuses_start_time ON work_order_time_statuses(start_time);
CREATE INDEX IF NOT EXISTS idx_work_order_time_statuses_created_by ON work_order_time_statuses(created_by);

ALTER TABLE work_order_time_statuses ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view work order time statuses"
  ON work_order_time_statuses
  FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.user_type = 'Master'
      AND users.is_active = true
    )
    OR
    EXISTS (
      SELECT 1 FROM work_orders wo
      WHERE wo.id = work_order_time_statuses.work_order_id
      AND (
        wo.created_by = auth.uid()
        OR wo.responsible = auth.uid()
        OR auth.uid() = ANY(wo.team_members)
        OR EXISTS (
          SELECT 1 FROM user_permissions up
          JOIN permissions p ON p.id = up.permission_id
          WHERE up.user_id = auth.uid()
          AND p.key = 'workOrders.view'
        )
      )
    )
  );

CREATE POLICY "Users can insert work order time statuses"
  ON work_order_time_statuses
  FOR INSERT
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.user_type = 'Master'
      AND users.is_active = true
    )
    OR
    (
      EXISTS (
        SELECT 1 FROM user_permissions up
        JOIN permissions p ON p.id = up.permission_id
        WHERE up.user_id = auth.uid()
        AND p.key = 'workOrders.timestatus'
      )
      AND created_by = auth.uid()
      AND EXISTS (
        SELECT 1 FROM work_orders wo
        WHERE wo.id = work_order_time_statuses.work_order_id
        AND (wo.responsible = auth.uid() OR auth.uid() = ANY(wo.team_members))
      )
      AND (
        status != 'PAUSADO' OR pause_reason IS NOT NULL
      )
    )
  );

CREATE POLICY "Users can update work order time statuses"
  ON work_order_time_statuses
  FOR UPDATE
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.user_type = 'Master'
      AND users.is_active = true
    )
    OR
    created_by = auth.uid()
    OR
    EXISTS (
      SELECT 1 FROM user_permissions up
      JOIN permissions p ON p.id = up.permission_id
      WHERE up.user_id = auth.uid()
      AND p.key = 'workOrders.timestatus'
      AND EXISTS (
        SELECT 1 FROM work_orders wo
        WHERE wo.id = work_order_time_statuses.work_order_id
        AND (wo.responsible = auth.uid() OR auth.uid() = ANY(wo.team_members))
      )
    )
  );

-- 2.4. Create work_order_service_logs table
CREATE TABLE IF NOT EXISTS work_order_service_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  work_order_id UUID NOT NULL REFERENCES work_orders(id) ON DELETE CASCADE,
  type VARCHAR(50) NOT NULL CHECK (type IN ('ajuste', 'problema', 'material', 'recomendacao')),
  text TEXT NOT NULL,
  author UUID NOT NULL REFERENCES users(id) ON DELETE RESTRICT,
  timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  photo_path TEXT,
  video_path TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_work_order_service_logs_work_order_id ON work_order_service_logs(work_order_id);
CREATE INDEX IF NOT EXISTS idx_work_order_service_logs_type ON work_order_service_logs(type);
CREATE INDEX IF NOT EXISTS idx_work_order_service_logs_author ON work_order_service_logs(author);
CREATE INDEX IF NOT EXISTS idx_work_order_service_logs_timestamp ON work_order_service_logs(timestamp);

ALTER TABLE work_order_service_logs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view work order service logs"
  ON work_order_service_logs
  FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.user_type = 'Master'
      AND users.is_active = true
    )
    OR
    EXISTS (
      SELECT 1 FROM work_orders wo
      WHERE wo.id = work_order_service_logs.work_order_id
      AND (
        wo.created_by = auth.uid()
        OR wo.responsible = auth.uid()
        OR auth.uid() = ANY(wo.team_members)
        OR EXISTS (
          SELECT 1 FROM user_permissions up
          JOIN permissions p ON p.id = up.permission_id
          WHERE up.user_id = auth.uid()
          AND p.key = 'workOrders.view'
        )
      )
    )
  );

CREATE POLICY "Users can insert work order service logs"
  ON work_order_service_logs
  FOR INSERT
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.user_type = 'Master'
      AND users.is_active = true
    )
    OR
    (
      EXISTS (
        SELECT 1 FROM user_permissions up
        JOIN permissions p ON p.id = up.permission_id
        WHERE up.user_id = auth.uid()
        AND p.key = 'workOrders.log'
      )
      AND author = auth.uid()
      AND EXISTS (
        SELECT 1 FROM work_orders wo
        WHERE wo.id = work_order_service_logs.work_order_id
        AND (wo.responsible = auth.uid() OR auth.uid() = ANY(wo.team_members))
      )
    )
  );

CREATE POLICY "Users can update work order service logs"
  ON work_order_service_logs
  FOR UPDATE
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.user_type = 'Master'
      AND users.is_active = true
    )
    OR
    author = auth.uid()
  );

CREATE POLICY "Users can delete work order service logs"
  ON work_order_service_logs
  FOR DELETE
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.user_type = 'Master'
      AND users.is_active = true
    )
    OR
    author = auth.uid()
  );

-- 2.5. Create work_order_evidences table
CREATE TABLE IF NOT EXISTS work_order_evidences (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  work_order_id UUID NOT NULL REFERENCES work_orders(id) ON DELETE CASCADE,
  type VARCHAR(50) NOT NULL CHECK (type IN ('antes', 'durante', 'depois')),
  photo_path TEXT NOT NULL,
  video_path TEXT,
  internal_notes TEXT,
  client_notes TEXT,
  created_by UUID NOT NULL REFERENCES users(id) ON DELETE RESTRICT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_work_order_evidences_work_order_id ON work_order_evidences(work_order_id);
CREATE INDEX IF NOT EXISTS idx_work_order_evidences_type ON work_order_evidences(type);
CREATE INDEX IF NOT EXISTS idx_work_order_evidences_created_by ON work_order_evidences(created_by);
CREATE INDEX IF NOT EXISTS idx_work_order_evidences_created_at ON work_order_evidences(created_at);

ALTER TABLE work_order_evidences ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view work order evidences"
  ON work_order_evidences
  FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.user_type = 'Master'
      AND users.is_active = true
    )
    OR
    EXISTS (
      SELECT 1 FROM work_orders wo
      WHERE wo.id = work_order_evidences.work_order_id
      AND (
        wo.created_by = auth.uid()
        OR wo.responsible = auth.uid()
        OR auth.uid() = ANY(wo.team_members)
        OR EXISTS (
          SELECT 1 FROM user_permissions up
          JOIN permissions p ON p.id = up.permission_id
          WHERE up.user_id = auth.uid()
          AND p.key = 'workOrders.view'
        )
      )
    )
  );

CREATE POLICY "Users can insert work order evidences"
  ON work_order_evidences
  FOR INSERT
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.user_type = 'Master'
      AND users.is_active = true
    )
    OR
    (
      EXISTS (
        SELECT 1 FROM user_permissions up
        JOIN permissions p ON p.id = up.permission_id
        WHERE up.user_id = auth.uid()
        AND p.key = 'workOrders.evidence'
      )
      AND created_by = auth.uid()
      AND EXISTS (
        SELECT 1 FROM work_orders wo
        WHERE wo.id = work_order_evidences.work_order_id
        AND (wo.responsible = auth.uid() OR auth.uid() = ANY(wo.team_members))
      )
    )
  );

CREATE POLICY "Users can update work order evidences"
  ON work_order_evidences
  FOR UPDATE
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.user_type = 'Master'
      AND users.is_active = true
    )
    OR
    created_by = auth.uid()
  );

CREATE POLICY "Users can delete work order evidences"
  ON work_order_evidences
  FOR DELETE
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.user_type = 'Master'
      AND users.is_active = true
    )
    OR
    created_by = auth.uid()
  );

-- 2.6. Create work_order_checklist_items table
CREATE TABLE IF NOT EXISTS work_order_checklist_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  work_order_id UUID NOT NULL REFERENCES work_orders(id) ON DELETE CASCADE,
  type VARCHAR(50) NOT NULL CHECK (type IN ('planned', 'execution')),
  title VARCHAR(255) NOT NULL,
  description TEXT,
  completed BOOLEAN DEFAULT false,
  completed_at TIMESTAMPTZ,
  completed_by UUID REFERENCES users(id) ON DELETE SET NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_work_order_checklist_items_work_order_id ON work_order_checklist_items(work_order_id);
CREATE INDEX IF NOT EXISTS idx_work_order_checklist_items_type ON work_order_checklist_items(type);
CREATE INDEX IF NOT EXISTS idx_work_order_checklist_items_completed ON work_order_checklist_items(completed);
CREATE INDEX IF NOT EXISTS idx_work_order_checklist_items_completed_by ON work_order_checklist_items(completed_by);

ALTER TABLE work_order_checklist_items ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view work order checklist items"
  ON work_order_checklist_items
  FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.user_type = 'Master'
      AND users.is_active = true
    )
    OR
    EXISTS (
      SELECT 1 FROM work_orders wo
      WHERE wo.id = work_order_checklist_items.work_order_id
      AND (
        wo.created_by = auth.uid()
        OR wo.responsible = auth.uid()
        OR auth.uid() = ANY(wo.team_members)
        OR EXISTS (
          SELECT 1 FROM user_permissions up
          JOIN permissions p ON p.id = up.permission_id
          WHERE up.user_id = auth.uid()
          AND p.key = 'workOrders.view'
        )
      )
    )
  );

CREATE POLICY "Users can insert work order checklist items"
  ON work_order_checklist_items
  FOR INSERT
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.user_type = 'Master'
      AND users.is_active = true
    )
    OR
    EXISTS (
      SELECT 1 FROM user_permissions up
      JOIN permissions p ON p.id = up.permission_id
      WHERE up.user_id = auth.uid()
      AND p.key IN ('workOrders.create', 'workOrders.update')
      AND EXISTS (
        SELECT 1 FROM work_orders wo
        WHERE wo.id = work_order_checklist_items.work_order_id
        AND (
          wo.created_by = auth.uid()
          OR wo.responsible = auth.uid()
          OR auth.uid() = ANY(wo.team_members)
        )
      )
    )
  );

CREATE POLICY "Users can update work order checklist items"
  ON work_order_checklist_items
  FOR UPDATE
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.user_type = 'Master'
      AND users.is_active = true
    )
    OR
    EXISTS (
      SELECT 1 FROM user_permissions up
      JOIN permissions p ON p.id = up.permission_id
      WHERE up.user_id = auth.uid()
      AND p.key = 'workOrders.update'
      AND EXISTS (
        SELECT 1 FROM work_orders wo
        WHERE wo.id = work_order_checklist_items.work_order_id
        AND (
          wo.created_by = auth.uid()
          OR wo.responsible = auth.uid()
          OR auth.uid() = ANY(wo.team_members)
        )
      )
    )
  )
  WITH CHECK (
    (completed = true AND completed_by = auth.uid() AND completed_at IS NOT NULL)
    OR
    (completed = false AND completed_by IS NULL AND completed_at IS NULL)
  );

CREATE POLICY "Users can delete work order checklist items"
  ON work_order_checklist_items
  FOR DELETE
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.user_type = 'Master'
      AND users.is_active = true
    )
    OR
    EXISTS (
      SELECT 1 FROM user_permissions up
      JOIN permissions p ON p.id = up.permission_id
      WHERE up.user_id = auth.uid()
      AND p.key = 'workOrders.update'
      AND EXISTS (
        SELECT 1 FROM work_orders wo
        WHERE wo.id = work_order_checklist_items.work_order_id
        AND (
          wo.created_by = auth.uid()
          OR wo.responsible = auth.uid()
          OR auth.uid() = ANY(wo.team_members)
        )
      )
    )
  );

-- 2.7. Create work_order_signatures table
CREATE TABLE IF NOT EXISTS work_order_signatures (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  work_order_id UUID NOT NULL REFERENCES work_orders(id) ON DELETE CASCADE,
  signature_path TEXT NOT NULL,
  full_name VARCHAR(255) NOT NULL,
  timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  latitude DECIMAL(10, 8) NOT NULL,
  longitude DECIMAL(11, 8) NOT NULL,
  pin_hash TEXT,
  created_by UUID NOT NULL REFERENCES users(id) ON DELETE RESTRICT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_work_order_signatures_work_order_id ON work_order_signatures(work_order_id);
CREATE INDEX IF NOT EXISTS idx_work_order_signatures_created_by ON work_order_signatures(created_by);
CREATE INDEX IF NOT EXISTS idx_work_order_signatures_timestamp ON work_order_signatures(timestamp);

CREATE UNIQUE INDEX IF NOT EXISTS idx_work_order_signatures_unique_work_order ON work_order_signatures(work_order_id);

ALTER TABLE work_order_signatures ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view work order signatures"
  ON work_order_signatures
  FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.user_type = 'Master'
      AND users.is_active = true
    )
    OR
    EXISTS (
      SELECT 1 FROM work_orders wo
      WHERE wo.id = work_order_signatures.work_order_id
      AND (
        wo.created_by = auth.uid()
        OR wo.responsible = auth.uid()
        OR auth.uid() = ANY(wo.team_members)
        OR EXISTS (
          SELECT 1 FROM user_permissions up
          JOIN permissions p ON p.id = up.permission_id
          WHERE up.user_id = auth.uid()
          AND p.key = 'workOrders.view'
        )
      )
    )
  );

CREATE POLICY "Users can insert work order signatures"
  ON work_order_signatures
  FOR INSERT
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.user_type = 'Master'
      AND users.is_active = true
    )
    OR
    (
      EXISTS (
        SELECT 1 FROM user_permissions up
        JOIN permissions p ON p.id = up.permission_id
        WHERE up.user_id = auth.uid()
        AND p.key = 'workOrders.signature'
      )
      AND created_by = auth.uid()
      AND EXISTS (
        SELECT 1 FROM work_orders wo
        WHERE wo.id = work_order_signatures.work_order_id
        AND wo.is_locked = false
        AND (
          wo.responsible = auth.uid()
          OR auth.uid() = ANY(wo.team_members)
        )
      )
      AND NOT EXISTS (
        SELECT 1 FROM work_order_signatures wos
        WHERE wos.work_order_id = work_order_signatures.work_order_id
      )
    )
  );

CREATE POLICY "Only master users can delete work order signatures"
  ON work_order_signatures
  FOR DELETE
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.user_type = 'Master'
      AND users.is_active = true
    )
  );

-- ============================================================================
-- FIM DA MIGRATION
-- ============================================================================
-- Todas as tabelas, índices, RLS policies e triggers foram criados.
-- Verifique no Table Editor do Supabase se todas as tabelas foram criadas:
-- - events
-- - event_attachments
-- - work_orders
-- - work_order_checkins
-- - work_order_time_statuses
-- - work_order_service_logs
-- - work_order_evidences
-- - work_order_checklist_items
-- - work_order_signatures
-- ============================================================================
